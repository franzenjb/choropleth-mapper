<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choropleth Mapper - Professional Data Visualization Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <div class="container">
            <div class="version-info" id="versionInfo"></div>
            
            <!-- Collapsible Sidebar for Instructions -->
            <div class="sidebar" id="sidebar">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="9"></line>
                        <line x1="9" y1="13" x2="15" y2="13"></line>
                    </svg>
                    <span>Data Formats</span>
                </button>
                
                <div class="sidebar-content">
                    <h3>Supported Geography Types</h3>
                    
                    <div class="format-section">
                        <h4>Counties</h4>
                        <p>Column: <code>GEOID</code> or <code>County Name</code></p>
                        <p>Format: 5-digit FIPS or Name</p>
                        <p>Examples: 12001, "York County", "York"</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Sub-Counties (CCDs)</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 10-digit CCD</p>
                        <p>Example: 1200191248</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>ZIP Codes</h4>
                        <p>Column: <code>ZIP</code></p>
                        <p>Format: 5-digit ZIP</p>
                        <p>Example: 32003</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Census Tracts</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 11-digit tract</p>
                        <p>Example: 12001020100</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Places/Cities</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 7-digit place</p>
                        <p>Example: 1200950</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>States</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 2-digit FIPS</p>
                        <p>Example: 12 (Florida)</p>
                    </div>
                    
                    <div class="sidebar-footer">
                        <strong>Sample Files:</strong>
                        <a href="#" onclick="downloadExampleCSV('county'); return false;">Counties</a>
                        <a href="#" onclick="downloadExampleCSV('zip'); return false;">ZIP</a>
                        <a href="#" onclick="downloadExampleCSV('place'); return false;">Places</a>
                    </div>
                </div>
            </div>
            
            <!-- Professional Header with Value Proposition -->
            <header class="app-header">
                <div class="header-brand">
                    <div class="brand-logo">+</div>
                    <div>
                        <h1 class="brand-title">Choropleth Mapper</h1>
                        <p class="brand-subtitle">Transform CSV Data into Professional Geographic Visualizations</p>
                    </div>
                </div>
                
                <!-- Executive Summary -->
                <div class="executive-summary">
                    <div class="narrative-section">
                        <p><strong>Purpose:</strong> Automates the creation of choropleth maps by joining CSV data with geographic boundaries. <strong>Function:</strong> Matches your data's geographic identifiers (FIPS codes, ZIP codes, place IDs) with Census/ESRI boundary files to generate properly formatted GeoJSON or Shapefiles. <strong>Application:</strong> Used for visualizing demographic data, resource allocation, and disaster response planning across counties, cities, and ZIP codes.</p>
                    </div>
                </div>
            </header>

            <!-- Main Workflow Section -->
            <div class="workflow-container">
                <!-- Step 1: Data Upload -->
                <div class="workflow-step" id="step1">
                    <div class="step-header">
                        <h2 class="step-title">
                            <span class="step-number">1</span>
                            Upload Your CSV Data
                        </h2>
                    </div>
                    <div class="step-content">
                        <div class="upload-area" id="uploadArea">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="upload-text">Drop CSV file here or click to browse</p>
                            <p class="upload-subtext">Supports any CSV with geographic identifiers</p>
                        </div>
                        <input type="file" id="csvInput" accept=".csv" hidden>
                        <div id="fileInfo" class="file-info hidden"></div>
                    </div>
                </div>

                <!-- Step 2: Configuration -->
                <div class="workflow-step" id="step2">
                    <div class="step-header">
                        <h2 class="step-title">
                            <span class="step-number">2</span>
                            Configure Your Map
                        </h2>
                    </div>
                    <div class="step-content">
                        <div class="hidden" id="configPanel">
                            <div class="form-group">
                                <label for="geoLevel" class="form-label">Geographic Level</label>
                                <select id="geoLevel" class="form-select">
                                    <option value="">Select geography type...</option>
                                    <option value="county">County</option>
                                    <option value="subcounty">Sub-County (CCD)</option>
                                    <option value="zip">ZIP Code (ZCTA)</option>
                                    <option value="tract">Census Tract</option>
                                    <option value="place">Place/City</option>
                                    <option value="state">State</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="joinColumn" class="form-label">Geography ID Column</label>
                                <select id="joinColumn" class="form-select">
                                    <option value="">Select column...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dataColumn" class="form-label">Data Column (for visualization)</label>
                                <select id="dataColumn" class="form-select">
                                    <option value="">Select column...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="stateFilter" class="form-label">
                                    State Filter <span id="stateRequired" style="color: red; display: none;">(REQUIRED for county names)</span>
                                </label>
                                <select id="stateFilter" class="form-select">
                                    <option value="">All states</option>
                                </select>
                            </div>

                            <!-- Legend Controls -->
                            <div class="legend-controls">
                                <h3>Map Legend Settings</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="classCount" class="form-label">Number of Classes</label>
                                        <select id="classCount" class="form-select">
                                            <option value="3">3 Classes</option>
                                            <option value="5" selected>5 Classes</option>
                                            <option value="7">7 Classes</option>
                                            <option value="9">9 Classes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="colorScheme" class="form-label">Color Scheme</label>
                                        <select id="colorScheme" class="form-select">
                                            <option value="reds" selected>Red Gradient (ARC)</option>
                                            <option value="blues">Blue Gradient</option>
                                            <option value="greens">Green Gradient</option>
                                            <option value="purples">Purple Gradient</option>
                                            <option value="oranges">Orange Gradient</option>
                                            <option value="diverging">Diverging (Red-Blue)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="classMethod" class="form-label">Classification Method</label>
                                    <select id="classMethod" class="form-select">
                                        <option value="quantile" selected>Quantile (Equal Count)</option>
                                        <option value="equal">Equal Interval</option>
                                        <option value="jenks">Natural Breaks (Jenks)</option>
                                        <option value="std">Standard Deviation</option>
                                    </select>
                                </div>
                            </div>

                            <button id="processBtn" class="btn btn-primary">Generate Map</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Preview & Export -->
                <div class="workflow-step" id="step3">
                    <div class="step-header">
                        <h2 class="step-title">
                            <span class="step-number">3</span>
                            Preview & Export
                        </h2>
                    </div>
                    <div class="step-content">
                        <div class="hidden" id="previewPanel">
                            <div class="map-container">
                                <div id="map"></div>
                            </div>
                            
                            <div class="export-panel">
                                <h3 class="export-title">Export Options</h3>
                                <p class="export-description">Download your choropleth map with joined data</p>
                                
                                <div class="export-buttons">
                                    <button id="exportGeoJSON" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        Export GeoJSON
                                    </button>
                                    
                                    <button id="exportShapefile" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <rect x="7" y="7" width="10" height="10" rx="1" ry="1"></rect>
                                        </svg>
                                        Export Shapefile
                                    </button>
                                    
                                    <button id="exportArcGIS" class="btn btn-primary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                        </svg>
                                        Upload to ArcGIS Online
                                    </button>
                                </div>
                                
                                <div class="export-divider"></div>
                                
                                <button id="zoomToFeatures" class="btn btn-success">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="11" cy="11" r="8"></circle>
                                        <path d="M21 21l-4.35-4.35"></path>
                                    </svg>
                                    Zoom to Features
                                </button>
                                <p class="instructions-note" style="margin-top: 0.5rem;">Click if map shows ocean instead of your data</p>
                            </div>
                            
                            <div class="stats-panel" id="stats"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loading" class="loading-overlay hidden">
                <div class="loading-spinner"></div>
                <p class="loading-text">Processing your data...</p>
            </div>

            <!-- Error Display -->
            <div id="error" class="error-panel hidden"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shpwrite@0.3.2/shpwrite.min.js"></script>
    <script src="app.js"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
        }
        
        function downloadExampleCSV(type) {
            let content = '';
            let filename = '';
            
            if (type === 'county') {
                filename = 'example_counties.csv';
                content = `GEOID,County,Population,UnemploymentRate
12001,Alachua County,278468,3.2
12003,Baker County,29210,4.1
12005,Bay County,175216,3.8
12007,Bradford County,28303,5.2
12009,Brevard County,601942,3.5`;
            } else if (type === 'zip') {
                filename = 'example_zipcodes.csv';
                content = `ZIP,Location,Households,PercentALICE
32003,Fleming Island,8234,28.5
32034,Fernandina Beach,6123,22.1
32043,Green Cove Springs,4567,35.2
32065,Orange Park,9876,31.4
32073,Orange Park,7654,26.8`;
            } else if (type === 'place') {
                filename = 'example_places.csv';
                content = `GEOID,Place,Population,MedianIncome
1200950,Jacksonville,954614,54701
1214250,Clearwater,117292,48183
1216475,Coral Springs,134394,77453
1224000,Fort Lauderdale,182760,59904
1235000,Hialeah,223109,40165`;
            }
            
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>