<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Choropleth Mapper - Professional Data Visualization Tool</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <div class="container">
            <div class="version-info" id="versionInfo"></div>
            
            <!-- Collapsible Sidebar for Instructions -->
            <div class="sidebar" id="sidebar">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="9"></line>
                        <line x1="9" y1="13" x2="15" y2="13"></line>
                    </svg>
                    <span>Data Formats</span>
                </button>
                
                <div class="sidebar-content">
                    <h3>Supported Geography Types</h3>
                    
                    <div class="format-section" style="background: #e8f4f8; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        <h4>üìç Using GEOIDs (Recommended)</h4>
                        <p><strong>GEOIDs are unique Census identifiers - always preferred!</strong></p>
                        <p>‚Ä¢ County: 5 digits (e.g., 23005 = Cumberland, ME)</p>
                        <p>‚Ä¢ Tract: 11 digits (e.g., 23005010100)</p>
                        <p>‚Ä¢ Block Group: 12 digits (e.g., 230050101001)</p>
                        <p>‚Ä¢ Place: 7 digits (e.g., 2360545 = Portland, ME)</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Counties</h4>
                        <p>Column: <code>GEOID</code>, <code>FIPS</code>, or <code>County Name</code></p>
                        <p>Format: 5-digit FIPS/GEOID or Name</p>
                        <p>Examples: 23005, "Cumberland County", "Cumberland"</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Sub-Counties (CCDs)</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 10-digit CCD</p>
                        <p>Example: 1200191248</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>ZIP Codes</h4>
                        <p>Column: <code>ZIP</code></p>
                        <p>Format: 5-digit ZIP</p>
                        <p>Example: 32003</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Census Tracts</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 11-digit tract</p>
                        <p>Example: 12001020100</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>Places/Cities</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 7-digit place</p>
                        <p>Example: 1200950</p>
                    </div>
                    
                    <div class="format-section">
                        <h4>States</h4>
                        <p>Column: <code>GEOID</code></p>
                        <p>Format: 2-digit FIPS</p>
                        <p>Example: 12 (Florida)</p>
                    </div>
                    
                    <div class="format-section" style="border-top: 1px solid #ddd; padding-top: 1rem; margin-top: 1rem;">
                        <h4 style="color: #28a745;">Auto-Aggregation</h4>
                        <p><strong>Raw Data Support:</strong></p>
                        <p>‚Ä¢ Automatically counts rows per geography</p>
                        <p>‚Ä¢ Sums numeric values when detected</p>
                        <p>‚Ä¢ No pre-processing needed</p>
                        <p style="font-size: 0.85rem; color: #666;">Example: 200 individual records with ZIP codes ‚Üí Automatically creates count per ZIP</p>
                    </div>
                    
                    <div class="sidebar-footer">
                        <strong>Sample Files:</strong>
                        <a href="#" onclick="downloadExampleCSV('county'); return false;">Counties</a>
                        <a href="#" onclick="downloadExampleCSV('zip'); return false;">ZIP</a>
                        <a href="#" onclick="downloadExampleCSV('place'); return false;">Places</a>
                    </div>
                </div>
            </div>
            
            <!-- Professional Header with Value Proposition -->
            <header class="app-header">
                <div class="header-brand">
                    <div class="brand-logo">üó∫Ô∏è</div>
                    <div>
                        <h1 class="brand-title">Choropleth Mapper</h1>
                        <p class="brand-subtitle">Transform CSV Data into Professional Geographic Visualizations</p>
                    </div>
                </div>
                
                <!-- Theme & Settings Controls -->
                <div class="header-controls">
                    <button id="themeToggle" class="theme-toggle" title="Toggle Dark/Light Theme">
                        <span class="theme-icon">üåì</span>
                        <span class="theme-label">Theme</span>
                    </button>
                    <div class="basemap-control">
                        <label for="basemapSelect" class="basemap-label">Base Map</label>
                        <select id="basemapSelect" class="basemap-select">
                            <option value="light" selected>Light</option>
                            <option value="dark">Dark</option>
                            <option value="satellite">Satellite</option>
                            <option value="streets">Streets</option>
                            <option value="topographic">Topographic</option>
                        </select>
                    </div>
                </div>
                
                <!-- Executive Summary -->
                <div class="executive-summary">
                    <div class="narrative-section">
                        <p><strong>Purpose:</strong> Automates the creation of choropleth maps by joining CSV data with geographic boundaries. <strong>Function:</strong> Matches your data's geographic identifiers (FIPS codes, ZIP codes, place IDs) with Census/ESRI boundary files to generate properly formatted GeoJSON or Shapefiles. <strong>Application:</strong> Used for visualizing demographic data, resource allocation, and disaster response planning across counties, cities, and ZIP codes.</p>
                    </div>
                </div>
            </header>

            <!-- Main Workflow Section -->
            <div class="workflow-container">
                <!-- Step 1: Data Upload -->
                <div class="workflow-step" id="step1">
                    <div class="step-header">
                        <h2 class="step-title">
                            <span class="step-number">1</span>
                            Upload Your CSV Data
                        </h2>
                    </div>
                    <div class="step-content">
                        <div class="upload-area" id="uploadArea">
                            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="17 8 12 3 7 8"></polyline>
                                <line x1="12" y1="3" x2="12" y2="15"></line>
                            </svg>
                            <p class="upload-text">Drop CSV file here or click to browse</p>
                            <p class="upload-subtext">Supports any CSV with geographic identifiers</p>
                        </div>
                        <input type="file" id="csvInput" accept=".csv" hidden>
                        <div id="fileInfo" class="file-info hidden"></div>
                    </div>
                </div>

                <!-- Step 2: Configuration -->
                <div class="workflow-step" id="step2">
                    <div class="step-header">
                        <h2 class="step-title">
                            <span class="step-number">2</span>
                            Configure Your Map
                        </h2>
                    </div>
                    <div class="step-content">
                        <div class="hidden" id="configPanel">
                            <div class="form-group">
                                <label for="geoLevel" class="form-label">Geographic Level</label>
                                <select id="geoLevel" class="form-select">
                                    <option value="">Select geography type...</option>
                                    <option value="zip">‚úÖ ZIP Code (5-digit)</option>
                                    <option value="county">‚úÖ County (Name, FIPS, or GEOID)</option>
                                    <option value="state">‚úÖ State (Name, Abbrev, or FIPS)</option>
                                    <option value="subcounty" disabled>üöß Sub-County (Coming Soon)</option>
                                    <option value="tract" disabled>üöß Census Tract (Coming Soon)</option>
                                    <option value="place" disabled>üöß Place/City (Coming Soon)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="joinColumn" class="form-label">Geography ID Column</label>
                                <select id="joinColumn" class="form-select">
                                    <option value="">Select column...</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="dataColumn" class="form-label">Data Column (for visualization)</label>
                                <select id="dataColumn" class="form-select">
                                    <option value="">Select column...</option>
                                </select>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.25rem;">
                                    <span style="color: #28a745;">‚úì Auto-aggregation:</span> If multiple rows share the same geography ID, values will be automatically counted or summed
                                </div>
                            </div>

                            <div class="form-group">
                                <label for="stateFilter" class="form-label">
                                    State Filter <span id="stateRequired" style="color: red; display: none;">(REQUIRED for county names)</span>
                                </label>
                                <select id="stateFilter" class="form-select">
                                    <option value="">All states</option>
                                </select>
                            </div>

                            <!-- Legend Controls -->
                            <div class="legend-controls">
                                <h3>Map Legend Settings</h3>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="classCount" class="form-label">Number of Classes</label>
                                        <select id="classCount" class="form-select">
                                            <option value="3">3 Classes</option>
                                            <option value="5" selected>5 Classes</option>
                                            <option value="7">7 Classes</option>
                                            <option value="9">9 Classes</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="colorScheme" class="form-label">Color Scheme</label>
                                        <select id="colorScheme" class="form-select">
                                            <option value="redcross" selected>Red Cross Brand</option>
                                            <option value="reds">Red Gradient (Emergency)</option>
                                            <option value="blues">Blue Gradient (Water)</option>
                                            <option value="greens">Green Gradient (Health)</option>
                                            <option value="oranges">Orange Gradient (Resources)</option>
                                            <option value="purples">Purple Gradient (Demographics)</option>
                                            <option value="diverging">Diverging (Blue-Red)</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="classMethod" class="form-label">Classification Method</label>
                                        <select id="classMethod" class="form-select">
                                            <option value="quantile" selected>Quantile (Equal Count)</option>
                                            <option value="equal">Equal Interval</option>
                                            <option value="jenks">Natural Breaks (Jenks)</option>
                                            <option value="std">Standard Deviation</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="baseMap" class="form-label">Base Map</label>
                                        <select id="baseMap" class="form-select">
                                            <option value="light" selected>Light (OpenStreetMap)</option>
                                            <option value="dark">Dark (CartoDB Dark)</option>
                                            <option value="satellite">Satellite (ESRI)</option>
                                            <option value="terrain">Terrain</option>
                                            <option value="none">No Base Map</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Display Options -->
                            <div class="form-group" style="margin-top: 1rem;">
                                <label class="checkbox-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="checkbox" id="useCustomLabels" style="width: auto;">
                                    <span>Use Display_label column from CSV</span>
                                </label>
                                <p style="font-size: 0.85rem; color: #666; margin: 0.25rem 0 0 1.5rem;">
                                    When checked, shows Display_label from your CSV. When unchecked, shows official geography names (ZIP codes, county names, etc.)
                                </p>
                            </div>

                            <button id="processBtn" class="btn btn-primary">Generate Map</button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Preview & Export -->
                <div class="workflow-step" id="step3">
                    <div class="step-header">
                        <h2 class="step-title">
                            <span class="step-number">3</span>
                            Preview & Export
                        </h2>
                    </div>
                    <div class="step-content">
                        <div class="hidden" id="previewPanel">
                            <div class="map-container">
                                <div id="map"></div>
                            </div>
                            
                            <div class="export-panel">
                                <h3 class="export-title">Export Options</h3>
                                <p class="export-description">Download your choropleth map with joined data</p>
                                
                                <div class="export-buttons">
                                    <button id="exportGeoJSON" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                        </svg>
                                        Export GeoJSON
                                    </button>
                                    
                                    <button id="exportShapefile" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                            <rect x="7" y="7" width="10" height="10" rx="1" ry="1"></rect>
                                        </svg>
                                        Export Shapefile
                                    </button>
                                    
                                    <button id="exportArcGIS" class="btn btn-primary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"></path>
                                        </svg>
                                        Upload to ArcGIS Online
                                    </button>
                                </div>
                                
                                <div class="export-divider"></div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button id="zoomToFeatures" class="btn btn-success">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="11" cy="11" r="8"></circle>
                                            <path d="M21 21l-4.35-4.35"></path>
                                        </svg>
                                        Zoom to Features
                                    </button>
                                    
                                    <button id="updateBaseMap" class="btn btn-secondary">
                                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="23 4 23 10 17 10"></polyline>
                                            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                                        </svg>
                                        Update Base Map
                                    </button>
                                </div>
                                <p class="instructions-note" style="margin-top: 0.5rem;">Click Zoom if map shows ocean ‚Ä¢ Click Update after changing base map</p>
                            </div>
                            
                            <div class="stats-panel" id="stats"></div>
                            
                            <!-- API Limits Notice -->
                            <div style="margin-top: 1rem; padding: 0.75rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px;">
                                <strong>‚ö†Ô∏è Large Dataset Note:</strong> 
                                <span style="font-size: 0.9rem;">API limit is 2,000 features per request. California ZIP codes (2,600) and census tracts (8,000+) will be automatically fetched in batches. Processing may take longer for these large datasets.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loading" class="loading-overlay hidden">
                <div class="loading-spinner"></div>
                <p class="loading-text">Processing your data...</p>
            </div>

            <!-- Error Display -->
            <div id="error" class="error-panel hidden"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/shpwrite@0.3.2/shpwrite.min.js"></script>
    <script src="https://unpkg.com/chroma-js@2.4.2/chroma.min.js"></script>
    <script src="app.js?v=2.3"></script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('expanded');
        }
        
        function downloadExampleCSV(type) {
            let content = '';
            let filename = '';
            
            if (type === 'county') {
                filename = 'example_counties.csv';
                content = `GEOID,County,Population,UnemploymentRate
12001,Alachua County,278468,3.2
12003,Baker County,29210,4.1
12005,Bay County,175216,3.8
12007,Bradford County,28303,5.2
12009,Brevard County,601942,3.5`;
            } else if (type === 'zip') {
                filename = 'example_zipcodes.csv';
                content = `ZIP,Location,Households,PercentALICE
32003,Fleming Island,8234,28.5
32034,Fernandina Beach,6123,22.1
32043,Green Cove Springs,4567,35.2
32065,Orange Park,9876,31.4
32073,Orange Park,7654,26.8`;
            } else if (type === 'place') {
                filename = 'example_places.csv';
                content = `GEOID,Place,Population,MedianIncome
1200950,Jacksonville,954614,54701
1214250,Clearwater,117292,48183
1216475,Coral Springs,134394,77453
1224000,Fort Lauderdale,182760,59904
1235000,Hialeah,223109,40165`;
            }
            
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Theme Management
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('choropleth-theme') || 'light';
                this.init();
            }

            init() {
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                this.updateToggleButton();
                
                // Theme toggle event listener
                document.getElementById('themeToggle').addEventListener('click', () => {
                    this.toggleTheme();
                });
            }

            toggleTheme() {
                this.currentTheme = this.currentTheme === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', this.currentTheme);
                localStorage.setItem('choropleth-theme', this.currentTheme);
                this.updateToggleButton();
                
                // Notify app about theme change
                if (window.choroplethApp && window.choroplethApp.onThemeChange) {
                    window.choroplethApp.onThemeChange(this.currentTheme);
                }
            }

            updateToggleButton() {
                const button = document.getElementById('themeToggle');
                const icon = button.querySelector('.theme-icon');
                const label = button.querySelector('.theme-label');
                
                if (this.currentTheme === 'dark') {
                    icon.textContent = '‚òÄÔ∏è';
                    label.textContent = 'Light';
                    button.setAttribute('title', 'Switch to Light Theme');
                } else {
                    icon.textContent = 'üåô';
                    label.textContent = 'Dark';
                    button.setAttribute('title', 'Switch to Dark Theme');
                }
            }

            getCurrentTheme() {
                return this.currentTheme;
            }
        }

        // Enhanced Basemap Manager
        class BasemapManager {
            constructor() {
                this.basemaps = {
                    light: {
                        url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                        attribution: '¬© OpenStreetMap contributors'
                    },
                    dark: {
                        url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                        attribution: '¬© CARTO ¬© OpenStreetMap contributors'
                    },
                    satellite: {
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                        attribution: '¬© Esri ¬© DigitalGlobe ¬© GeoEye ¬© Earthstar Geographics'
                    },
                    streets: {
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',
                        attribution: '¬© Esri'
                    },
                    topographic: {
                        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',
                        attribution: '¬© Esri'
                    }
                };
                
                this.currentBasemap = 'light';
                this.init();
            }

            init() {
                document.getElementById('basemapSelect').addEventListener('change', (e) => {
                    this.changeBasemap(e.target.value);
                });
            }

            changeBasemap(basemapId) {
                this.currentBasemap = basemapId;
                
                // Notify app about basemap change
                if (window.choroplethApp && window.choroplethApp.onBasemapChange) {
                    window.choroplethApp.onBasemapChange(basemapId, this.basemaps[basemapId]);
                }
            }

            getBasemap(id) {
                return this.basemaps[id] || this.basemaps.light;
            }

            getCurrentBasemap() {
                return this.getBasemap(this.currentBasemap);
            }
        }

        // Enhanced Color Scheme Manager using Chroma.js
        class ColorSchemeManager {
            constructor() {
                this.schemes = {
                    reds: {
                        name: 'Red Gradient (Emergency)',
                        colors: ['#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15']
                    },
                    blues: {
                        name: 'Blue Gradient (Water)',
                        colors: ['#eff3ff', '#bdd7e7', '#6baed6', '#3182bd', '#08519c']
                    },
                    greens: {
                        name: 'Green Gradient (Health)',
                        colors: ['#edf8e9', '#bae4b3', '#74c476', '#31a354', '#006d2c']
                    },
                    oranges: {
                        name: 'Orange Gradient (Resources)',
                        colors: ['#feedde', '#fdbe85', '#fd8d3c', '#e6550d', '#a63603']
                    },
                    purples: {
                        name: 'Purple Gradient (Demographics)',
                        colors: ['#f2f0f7', '#cbc9e2', '#9e9ac8', '#756bb1', '#54278f']
                    },
                    redcross: {
                        name: 'Red Cross Brand',
                        colors: ['#fff5f5', '#fed7d7', '#feb2b2', '#fc8181', '#e53e3e']
                    },
                    diverging: {
                        name: 'Diverging (Blue-Red)',
                        colors: ['#2166ac', '#67a9cf', '#f7f7f7', '#ef8a62', '#b2182b']
                    }
                };
            }

            generateColorScale(scheme, numClasses = 5) {
                const schemeData = this.schemes[scheme] || this.schemes.reds;
                
                if (window.chroma) {
                    // Use chroma.js for professional color interpolation
                    return chroma.scale(schemeData.colors)
                        .mode('lab')
                        .colors(numClasses);
                } else {
                    // Fallback to predefined colors
                    return schemeData.colors.slice(0, numClasses);
                }
            }

            getSchemeNames() {
                return Object.entries(this.schemes).map(([key, value]) => ({
                    id: key,
                    name: value.name
                }));
            }
        }

        // Initialize managers when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            window.themeManager = new ThemeManager();
            window.basemapManager = new BasemapManager();
            window.colorSchemeManager = new ColorSchemeManager();
            
            // Make managers available globally for the main app
            window.choroplethManagers = {
                theme: window.themeManager,
                basemap: window.basemapManager,
                colorScheme: window.colorSchemeManager
            };
        });
    </script>
</body>
</html>